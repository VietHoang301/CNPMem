{% extends "base.html" %}
{% block title %}Tuy·∫øn xe bu√Ωt{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="text-center mb-4">Tuy·∫øn xe bu√Ωt (demo)</h1>

  <div class="row g-3 align-items-stretch">
    <!-- LEFT: danh s√°ch tuy·∫øn -->
    <div class="col-lg-4">
      <div class="sb-box p-3 border rounded bg-white h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-bold">Danh s√°ch tuy·∫øn</div>
          <span class="badge text-bg-dark"><span id="routeCount">{{ routes|length }}</span> tuy·∫øn</span>
        </div>

        <input id="routeSearch" class="form-control form-control-sm mb-2" placeholder="T√¨m: 01, H·ªôi An, B·∫øn xe Trung t√¢m..." />

        <select id="routeSelect" class="form-select form-select-sm mb-2">
          {% for r in routes %}
            <option value="{{ r.maTuyen }}">{{ r.maHienThi }} ‚Äî {{ r.tenTuyen or 'Ch∆∞a ƒë·∫∑t t√™n' }}</option>
          {% endfor %}
        </select>
        <div class="form-text mb-2">Tip: b·∫°n c√≥ th·ªÉ click tr·ª±c ti·∫øp d√≤ng trong b·∫£ng b√™n d∆∞·ªõi.</div>

        <div class="table-responsive" style="max-height: 460px; overflow:auto;">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light" style="position: sticky; top: 0;">
              <tr>
                <th style="width: 90px;">M√£</th>
                <th>Tuy·∫øn</th>
              </tr>
            </thead>
            <tbody id="routeTableBody">
              {% for r in routes %}
              <tr class="route-row"
                  role="button"
                  data-route-id="{{ r.maTuyen }}"
                  data-code="{{ r.maHienThi }}"
                  data-name="{{ r.tenTuyen or '' }}"
                  data-start="{{ r.diemBatDau or '' }}"
                  data-end="{{ r.diemKetThuc or '' }}"
                  data-text="{{ (r.maHienThi ~ ' ' ~ (r.tenTuyen or '') ~ ' ' ~ (r.diemBatDau or '') ~ ' ' ~ (r.diemKetThuc or ''))|lower }}">
                <td class="fw-bold">{{ r.maHienThi }}</td>
                <td>
                  <div class="fw-semibold">{{ r.tenTuyen or "‚Äî" }}</div>
                  <div class="text-muted small">{{ r.diemBatDau or "‚Äî" }} ‚Üí {{ r.diemKetThuc or "‚Äî" }}</div>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="text-muted">Ch∆∞a c√≥ tuy·∫øn n√†o.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div id="emptyState" class="text-muted small mt-2 d-none">
          Kh√¥ng t√¨m th·∫•y tuy·∫øn ph√π h·ª£p. Th·ª≠ t·ª´ kho√° kh√°c.
        </div>
      </div>
    </div>

    <!-- MID: Bus overview instead of map -->
    <div class="col-lg-4">
      <div class="sb-box p-4 border rounded bg-white h-100 bus-hero">
        <div class="d-flex align-items-center mb-3">
          <div class="bus-hero__icon me-3">üöå</div>
          <div>
            <div class="fw-bold fs-5">Bus Overview Panel</div>
            <div class="text-muted small">Ki·∫øn tr√∫c CNPM: th√¥ng tin chung, kh√¥ng ph·ª• thu·ªôc b·∫£n ƒë·ªì.</div>
          </div>
        </div>
        <div class="bus-hero__card p-3 mb-2">
          <div class="fw-semibold">L·ªô tr√¨nh m√¥ t·∫£</div>
          <div class="text-muted small">
            Ch·ªçn tuy·∫øn ·ªü b·∫£ng b√™n tr√°i ƒë·ªÉ xem KPI d·ªØ li·ªáu, tr·∫°ng th√°i to·∫° ƒë·ªô v√† chuy·ªÉn sang trang chi ti·∫øt khi c·∫ßn demo map.
          </div>
        </div>
        <ul class="text-muted small mb-0 ps-3">
          <li>T√°ch r√µ 2 h∆∞·ªõng DI/VE, tr√°nh d√≠nh d·ªØ li·ªáu khi ƒë·ªïi.</li>
          <li>Khi API l·ªói/thi·∫øu tr·∫°m: panel v·∫´n s·∫°ch, kh√¥ng hi·ªÉn th·ªã d·ªØ li·ªáu c≈©.</li>
          <li>OSRM v√† danh s√°ch tr·∫°m ch·ªâ hi·ªÉn th·ªã trong trang chi ti·∫øt tuy·∫øn.</li>
        </ul>
      </div>
    </div>

    <!-- RIGHT: Route KPI -->
    <div class="col-lg-4">
      <div class="sb-box p-3 border rounded bg-white h-100" id="routeSummaryPanel">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <div class="fw-bold" id="selectedRouteTitle">Ch∆∞a ch·ªçn tuy·∫øn</div>
            <div class="text-muted small" id="selectedRouteMeta">‚Äî</div>
          </div>
          <span id="kpiDataStatus" class="badge text-bg-secondary">‚Äî</span>
        </div>

        <div id="routeSummaryError" class="alert alert-warning py-2 px-3 d-none">Kh√¥ng t·∫£i ƒë∆∞·ª£c KPI tuy·∫øn.</div>

        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="border rounded p-2 h-100">
              <div class="text-muted small">L∆∞·ª£t ƒëi (DI)</div>
              <div class="fw-bold" id="kpiStopsDI">0 tr·∫°m</div>
              <div class="text-muted small" id="kpiStopsDIGeo">‚Äî t·ªça ƒë·ªô</div>
            </div>
          </div>
          <div class="col-6">
            <div class="border rounded p-2 h-100">
              <div class="text-muted small">L∆∞·ª£t v·ªÅ (VE)</div>
              <div class="fw-bold" id="kpiStopsVE">0 tr·∫°m</div>
              <div class="text-muted small" id="kpiStopsVEGeo">‚Äî t·ªça ƒë·ªô</div>
            </div>
          </div>
          <div class="col-12">
            <div class="border rounded p-2">
              <div class="text-muted small">T·ª∑ l·ªá tr·∫°m c√≥ t·ªça ƒë·ªô</div>
              <div class="fw-bold" id="kpiGeoPercent">0%</div>
            </div>
          </div>
        </div>

        <a id="btnRouteDetail" class="btn btn-primary w-100 mb-2 disabled" href="#">Xem chi ti·∫øt tuy·∫øn</a>
        <a class="btn btn-outline-secondary w-100" href="{{ url_for('home') }}">V·ªÅ trang ch·ªß</a>
      </div>
    </div>
  </div>
</div>

<style>
  .bus-hero {
    position: relative;
    background: linear-gradient(135deg, #f7fbff 0%, #eef2ff 100%);
  }
  .bus-hero__icon {
    width: 64px;
    height: 64px;
    border-radius: 14px;
    display: grid;
    place-items: center;
    font-size: 32px;
    background: #0d6efd;
    color: #fff;
  }
  .bus-hero__card {
    border: 1px dashed #cdd5f5;
    border-radius: 12px;
    background: #fff;
  }
</style>

<script>
  window.__initialRouteId = {{ initial_route_id|default('null') }};
</script>

<script src="{{ url_for('static', filename='js/routes_dashboard.js') }}"></script>
{% endblock %}
