<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8">
    <title>SmartBus - {% block title %}{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <!-- CSS riêng của dự án -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    >

    <!-- Leaflet CSS (map) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('home') }}">SmartBus</a>

        <button class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <!-- Menu trái -->
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('routes') }}">Tuyến xe</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('tickets') }}">Vé / Hóa đơn</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('card_register') }}">Thẻ xe</a>
            </li>
            {% if user and user.vai_tro == 'ADMIN' %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('admin_routes') }}">Admin</a>
            </li>
            {% endif %}
          </ul>

          <!-- Menu phải -->
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            {% if user %}
            <li class="nav-item d-flex align-items-center">
              <span class="navbar-text me-2">
                Xin chào,
                {{ user.hoTen if user.hoTen is defined and user.hoTen else user.email }}
              </span>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">Đăng xuất</a>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('login') }}">Đăng nhập</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('register') }}">Đăng ký</a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <!-- CONTENT -->
    <div class="container mb-4">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          {% for msg in messages %}
            <div class="alert alert-info">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
    </script>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin="">
    </script>

    <!-- SmartBus Map + OSRM -->
    <script>
      // cache map để tránh lỗi "Map container is already initialized"
      window.__smartbusMaps = window.__smartbusMaps || {};

      function destroyMapIfExists(mapId) {
        if (window.__smartbusMaps[mapId]) {
          window.__smartbusMaps[mapId].remove();
          delete window.__smartbusMaps[mapId];
        }
      }

      async function fetchOsrmRoute(latlngList) {
        // gọi backend của bạn để tránh CORS và sau này đổi OSRM server dễ
        const res = await fetch("/api/osrm/route", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ coords: latlngList })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          throw new Error(data.error || "OSRM error");
        }
        return data; // { distance_m, duration_s, geometry }
      }

      function drawStraightLine(map, latlngs) {
        if (latlngs.length >= 2) {
          L.polyline(latlngs).addTo(map);
        }
      }

      function geoJsonLineToLatLng(geometry) {
        if (!geometry || geometry.type !== "LineString" || !Array.isArray(geometry.coordinates)) return [];
        return geometry.coordinates.map(c => [c[1], c[0]]); // [lng,lat] -> [lat,lng]
      }

      /**
       * Vẽ map tuyến với danh sách trạm.
       *  - stops: [{ lat, lng, name, address, order }, ...]
       *  - mapId: id của <div> chứa map
       *  - dùng OSRM để lấy đường đi thực tế, fail thì fallback đường thẳng
       */
      async function renderRouteMap(stops, mapId) {
        const container = document.getElementById(mapId);
        if (!container || !window.L || !stops || !stops.length) return;

        // sort theo order nếu có
        const pts = (stops || [])
          .filter(s => s && s.lat != null && s.lng != null)
          .map(s => ({
            lat: Number(s.lat),
            lng: Number(s.lng),
            name: s.name || "",
            address: s.address || "",
            order: Number(s.order ?? 0),
          }))
          .filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng))
          .sort((a, b) => (a.order || 0) - (b.order || 0));

        if (pts.length === 0) return;

        // reset map nếu đã tồn tại
        destroyMapIfExists(mapId);

        const map = L.map(mapId);
        window.__smartbusMaps[mapId] = map;

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        // markers
        const markerLatLngs = [];
        pts.forEach((p, idx) => {
          const ll = [p.lat, p.lng];
          markerLatLngs.push(ll);

          const label = (p.order ? (p.order + ". ") : (idx + 1 + ". ")) + (p.name || "");
          const popup = "<b>" + label + "</b>" + (p.address ? "<br>" + p.address : "");
          L.marker(ll).addTo(map).bindPopup(popup);
        });

        // fit marker bounds trước
        map.fitBounds(markerLatLngs, { padding: [20, 20] });

        // route OSRM
        if (markerLatLngs.length >= 2) {
          try {
            // thử route full 1 lần
            const data = await fetchOsrmRoute(markerLatLngs);
            const lineLatLngs = geoJsonLineToLatLng(data.geometry);

            if (lineLatLngs.length) {
              L.polyline(lineLatLngs).addTo(map);
              map.fitBounds(lineLatLngs, { padding: [20, 20] });
            } else {
              drawStraightLine(map, markerLatLngs);
            }
          } catch (e) {
            // fallback: route theo từng cặp để "ít fail" hơn
            console.warn("OSRM full route failed => fallback pairwise:", e.message);
            for (let i = 0; i < markerLatLngs.length - 1; i++) {
              const seg = [markerLatLngs[i], markerLatLngs[i + 1]];
              try {
                const data = await fetchOsrmRoute(seg);
                const segLine = geoJsonLineToLatLng(data.geometry);
                if (segLine.length) L.polyline(segLine).addTo(map);
                else drawStraightLine(map, seg);
              } catch (err) {
                console.warn("OSRM segment failed => straight:", err.message);
                drawStraightLine(map, seg);
              }
            }
          }
        }
      }
    </script>
  </body>
</html>
