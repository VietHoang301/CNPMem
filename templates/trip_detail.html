{% extends "base.html" %}
{% block title %}Chuyến #{{ trip.maChuyen }}{% endblock %}

{% block content %}
{% if is_admin_mode %}
  <a href="{{ url_for('admin_route_trips', tuyen_id=trip.tuyen_id) }}"
     class="btn btn-outline-secondary mb-3">
    &laquo; Quay lại quản lý chuyến
  </a>
{% else %}
  <a href="{{ url_for('route_detail', tuyen_id=trip.tuyen_id) }}"
     class="btn btn-outline-secondary mb-3">
    &laquo; Quay lại tuyến
  </a>
{% endif %}

<div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
  <div>
    <h2 class="mb-1">Chuyến #{{ trip.maChuyen }}</h2>
    <div class="text-muted">
      Tuyến <b>{{ tuyen.maHienThi }}</b> — {{ tuyen.tenTuyen or "—" }}<br>
      {{ tuyen.diemBatDau or "—" }} → {{ tuyen.diemKetThuc or "—" }}
      </div>
    </div>

    <div class="text-end">
      <div class="text-muted small">Ngày / giờ khởi hành</div>
      <div class="fw-semibold">
        {{ trip.ngayKhoiHanh }} — {{ trip.gioKhoiHanh }}
        {% if is_past_trip %}<span class="badge text-bg-secondary ms-2">Đã khởi hành</span>{% endif %}
      </div>
    </div>
  </div>

<div class="row g-3 mt-2">
  <div class="col-lg-7">
    <div class="sb-box sb-box--map">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Lộ trình (theo trạm)</h5>
        <span class="text-muted small">OSRM (fallback đường thẳng)</span>
      </div>
      <div id="trip-map" class="border rounded" style="height: 420px; overflow:hidden;"></div>

<script src="{{ url_for('static', filename='js/maps_osrm.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const stops = {{ stops_geo|tojson|safe }};
    await renderRouteMap(stops, "trip-map");
  });
</script>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="sb-box">
      <h5 class="mb-2">Danh sách trạm</h5>
      <div class="sb-stop-list" style="max-height: 340px;">
        <ul class="sb-stop-ul mb-0">
          {% for s in stops %}
            <li class="sb-stop-item">
              <div class="fw-semibold">{{ s.thuTuTrenTuyen }}. {{ s.tenTram }}</div>
              {% if s.diaChi %}<div class="text-muted small">{{ s.diaChi }}</div>{% endif %}
            </li>
          {% else %}
            <li class="text-muted">Tuyến này chưa có danh sách trạm dừng.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="mt-3 row g-2">
        <div class="col-6">
          <div class="border rounded p-2 text-center">
            <div class="text-muted small">Ghế đã đặt</div>
            <div class="fw-bold">{{ booked_seats|length }} / {{ seat_capacity }}</div>
          </div>
        </div>
        <div class="col-6">
          <div class="border rounded p-2 text-center">
            <div class="text-muted small">Còn trống</div>
            <div class="fw-bold">{{ available_seats|length }}</div>
          </div>
        </div>
      </div>

      <div class="mt-3 d-grid gap-2">
        {% if user %}
          <a class="btn btn-success {% if is_past_trip %}disabled{% endif %}" href="{{ url_for('booking', trip_id=trip.maChuyen) }}">
            {% if is_past_trip %}Chuyến đã khởi hành{% else %}Đặt vé chuyến này{% endif %}
          </a>
        {% else %}
          <a class="btn btn-dark" href="{{ url_for('login', next=url_for('booking', trip_id=trip.maChuyen)) }}">
            Đăng nhập để đặt vé
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
