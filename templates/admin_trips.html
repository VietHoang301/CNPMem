{% extends "base.html" %}
{% block title %}Quản lý chuyến - {{ tuyen.maHienThi }}{% endblock %}

{% block content %}
<div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
  <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('home') }}">Trang chủ</a>
  <a class="btn btn-outline-primary btn-sm" href="{{ url_for('admin_routes') }}">Admin tuyến</a>
  <span class="badge text-bg-primary px-3 py-2">Chuyến {{ tuyen.maHienThi }}</span>
</div>

<div class="d-flex flex-wrap justify-content-between align-items-end mb-3">
  <div>
    <h2 class="mb-1">Chuyến xe của tuyến {{ tuyen.maHienThi }} - {{ tuyen.tenTuyen }}</h2>
    <div class="text-muted small">Thêm chuyến theo ngày/giờ; xem map và danh sách trạm ở panel phải.</div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-7 d-flex flex-column">
    <div class="sb-box mb-3">
      <form method="post" class="row g-3 align-items-end">
        <input type="hidden" name="action" value="{{ 'edit_trip' if edit_trip else 'add_trip' }}">
        <input type="hidden" name="trip_id" value="{{ edit_trip.maChuyen if edit_trip else '' }}">

        <div class="col-md-4">
          <label class="form-label mb-1">Ngày khởi hành</label>
          <input class="form-control" name="ngayKhoiHanh" placeholder="YYYY-MM-DD"
                 value="{{ edit_trip.ngayKhoiHanh if edit_trip else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Giờ khởi hành</label>
          <input class="form-control" name="gioKhoiHanh" placeholder="HH:MM"
                 value="{{ edit_trip.gioKhoiHanh if edit_trip else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Hướng</label>
          {% set current_dir = (edit_trip.huong if edit_trip else 'DI') %}
          <select class="form-select" name="huong">
            <option value="DI" {% if current_dir == 'DI' %}selected{% endif %}>DI (Lượt đi)</option>
            <option value="VE" {% if current_dir == 'VE' %}selected{% endif %}>VE (Lượt về)</option>
          </select>
        </div>

        <div class="col-md-2 d-grid">
          <button class="btn btn-primary">
            {{ "Cập nhật chuyến" if edit_trip else "Thêm chuyến" }}
          </button>
        </div>
      </form>
    </div>

    <div class="sb-box d-flex flex-column flex-grow-1">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Danh sách chuyến</h5>
      </div>
      <div class="sb-table-scroll sb-table-scroll--fill">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Ngày</th>
              <th>Giờ</th>
              <th>Hướng</th>
              <th class="text-end">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            {% for trip in trips %}
            <tr>
              <td>#{{ trip.maChuyen }}</td>
              <td>{{ trip.ngayKhoiHanh }}</td>
              <td>{{ trip.gioKhoiHanh }}</td>
              <td><span class="badge text-bg-light">{{ trip.huong or 'DI' }}</span></td>
              <td class="text-end d-flex justify-content-end gap-1 flex-wrap">
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ url_for('trip_detail', trip_id=trip.maChuyen, mode='admin') }}">
                  Xem
                </a>

                <a class="btn btn-sm btn-outline-primary"
                   href="{{ url_for('admin_route_trips', tuyen_id=tuyen.maTuyen, edit=trip.maChuyen) }}">
                  Sửa
                </a>

                <form method="post"
                      action="{{ url_for('delete_trip', trip_id=trip.maChuyen) }}"
                      onsubmit="return confirm('Xóa chuyến này? (không xóa được nếu đã có vé)');">
                  <button class="btn btn-sm btn-outline-danger">Xóa</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center text-muted">Chưa có chuyến nào.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-lg-5 d-flex flex-column">
    <div class="sb-box mb-3">
      <h5 class="mb-2">Bản đồ trạm (read-only)</h5>
      <div id="stops-map" class="border rounded sb-map" style="height: 420px;"></div>
    </div>
    <div class="sb-box d-flex flex-column flex-grow-1">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Danh sách trạm</h5>
        <span class="text-muted small">DI/VE</span>
      </div>
      <div class="sb-stop-list sb-stop-scroll sb-stop-scroll--compact">
        <ul class="sb-stop-ul mb-0">
          {% for s in stops %}
            {% set dir = (s.huong or 'DI')|upper %}
            <li class="sb-stop-item sb-stop-item--click js-stop-zoom"
                data-lat="{{ s.lat }}" data-lng="{{ s.lng }}">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div class="fw-semibold">
                  <span class="badge text-bg-{{ 'success' if dir == 'DI' else 'secondary' }} me-2">{{ dir }}</span>
                  {{ s.thuTuTrenTuyen }}. {{ s.tenTram }}
                </div>
                <a class="badge text-bg-light text-decoration-none"
                   href="{{ url_for('stop_detail', stop_id=s.maTram) }}">
                  Trạm
                </a>
              </div>
              <div class="text-muted small">{{ s.diaChi or "" }}</div>
            </li>
          {% else %}
            <li class="text-muted">Chưa có trạm.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="{{ static_url('js/maps_osrm.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const stops = {{ stops_geo|tojson|safe }};
    if (typeof renderStopsMap === "function") renderStopsMap(stops, "stops-map");

    document.querySelectorAll(".js-stop-zoom").forEach((el) => {
      const lat = Number(el.dataset.lat);
      const lng = Number(el.dataset.lng);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
      el.addEventListener("click", (e) => {
        if (e?.target?.closest?.("a")) return;
        if (typeof focusStopOnMap === "function") focusStopOnMap("stops-map", lat, lng, 16);
      });
    });
  });
</script>
{% endblock %}
